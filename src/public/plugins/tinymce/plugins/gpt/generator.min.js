var eventSource,prepend,content=parent.tinymce.activeEditor.selection.getContent({format:"html"});$((function(){""!==content&&($("#nav-gpt-rewrite").show(),$(".original-content").val($("<textarea/>").html(content).text())),$(document).on("change","#rewrite-type",(function(){$("#rewrite-options").show(),"translate"===$(this).val()&&$("#rewrite-options").hide()})),$('[name="topic"]').focus(),$(document).on("click",'button[type="submit"]',(function(t){t.preventDefault(),$.ajax({url:gpt.route,type:"post",data:$(this).closest("form").serialize(),success:function(t){$(".error-bubble").remove(),$(".is-invalid").removeClass("is-invalid"),!1===t.success?($("#"+t.tab).html(t.html),$("#"+t.tab+" input:visible:first-child").focus()):($("#form, #buttons").hide(),$("#content, #stop").show(),$("#gpt-result").html(""),prepend=t.prepend,(eventSource=new EventSource(gpt.stream+"?id="+t.id)).onmessage=function(t){if("[DONE]"==t.data)$("#stop").hide(),$("#buttons").show(),eventSource.close();else{let e=JSON.parse(t.data).choices[0].delta.content;void 0!==e&&(e=e.replace(/(?:\r\n|\r|\n)/g,"<br>"),e=e.replace(/"/g,""),$("#gpt-result").append(e))}})},error:function(){$(this).closest("form").append('<div class="alert alert-danger" id="gpterror">'+gpt.error+"</div>")}})})),$(document).on("click","#stop",(function(){$("#stop").hide(),$("#buttons").show(),eventSource.close()})),$(document).on("click","#copy",(function(){navigator.clipboard.writeText($("#gpt-result").html()).then((function(){growl(gpt.copy)}),(function(){growl(gpt.copyerror)}))})),$(document).on("click","#undo",(function(){$("#form").show(),$("#content").hide()})),$(document).on("click","#close",(function(){window.parent.tinyMCE.activeEditor.windowManager.close()})),$(document).on("click","#confirm",(function(){window.parent.postMessage({mceAction:"confirmGPTContent",content:$("#gpt-result").html(),prepend:prepend},"*")}))}));
